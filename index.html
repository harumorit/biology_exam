<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç”Ÿç‰©â…¡ æœŸæœ«å¯¾ç­–ã‚¯ã‚¤ã‚º</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; background:#0b0f14; color:#e8eef7; }
    header { padding:16px; border-bottom:1px solid #333; background:#111826; position:sticky; top:0; z-index:10; }
    h1 { margin:0 0 10px; font-size:18px; }
    select, button, label {
      padding:8px 12px; margin-right:6px; background:#1b2435; color:#fff;
      border:1px solid #444; border-radius:8px; cursor:pointer;
    }
    button.secondary { background:#172033; }
    button.danger { background:#3d0f1a; border-color:#6b2331; }
    button.ok { background:#0f3d2e; border-color:#1f6b53; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    main { max-width: 980px; margin: 0 auto; padding: 20px; }
    .card { background:#121923; padding:20px; border-radius:12px; border:1px solid #333; }
    .choice { display:block; width:100%; margin:8px 0; padding:10px; text-align:left; }
    .result { margin-top:16px; padding:12px; border-radius:8px; display:none; }
    .good { background:#0f3d2e; }
    .bad { background:#3d0f1a; }
    .meta { margin-top:10px; font-size:13px; color:#aaa; white-space:pre-wrap; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .modalBackdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:18px;
      z-index: 50;
    }
    .modal{
      width:min(920px, 100%); max-height: 85vh; overflow:auto;
      background:#121923; border:1px solid #333; border-radius:14px; padding:16px;
    }
    .modal h2{ margin:0 0 10px; font-size:16px; }
    .listItem{
      border:1px solid #2a3448; border-radius:12px; padding:10px; margin:8px 0;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .listItem .left{ flex:1; }
    .small{ font-size:12px; color:#aab; }
    .pill{ display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #2a3448; color:#aab; }
    .spacer { flex: 1; }
    .toggle {
      display:inline-flex; align-items:center; gap:8px;
      background:#172033; border:1px solid #444; border-radius:999px;
      padding:6px 10px;
    }
    .toggle input { transform: scale(1.15); }
    .hint { color:#aab; font-size:12px; margin-top:6px; }
  </style>
</head>

<body>
<header>
  <h1>ç”Ÿç‰©â…¡ æœŸæœ«å¯¾ç­–ã‚¯ã‚¤ã‚º</h1>

  <div class="row">
    <select id="lectureFilter">
      <option value="all">å…¨è¬›ç¾©</option>
      <option value="1">ç¬¬1è¬›</option><option value="2">ç¬¬2è¬›</option><option value="3">ç¬¬3è¬›</option>
      <option value="4">ç¬¬4è¬›</option><option value="5">ç¬¬5è¬›</option><option value="6">ç¬¬6è¬›</option>
      <option value="7">ç¬¬7è¬›</option><option value="8">ç¬¬8è¬›</option><option value="9">ç¬¬9è¬›</option>
      <option value="10">ç¬¬10è¬›</option><option value="11">ç¬¬11è¬›</option><option value="12">ç¬¬12è¬›</option>
      <option value="13">ç¬¬13è¬›</option>
    </select>

    <button id="btnStart">ãƒ©ãƒ³ãƒ€ãƒ é–‹å§‹</button>
    <button id="btnWrong" class="secondary">é–“é•ã„å¾©ç¿’</button>
    <button id="btnWrongList" class="secondary">é–“é•ã„ä¸€è¦§</button>
    <button id="btnWrongReset" class="danger">é–“é•ã„ãƒªã‚»ãƒƒãƒˆ</button>

    <label class="toggle" title="è§£èª¬ã‚’èª­ã‚“ã§ã‹ã‚‰æ¬¡ã¸é€²ã‚€å‹‰å¼·ç”¨ãƒ¢ãƒ¼ãƒ‰">
      <input type="checkbox" id="studyModeToggle" />
      <span>ğŸ“˜ å‹‰å¼·ãƒ¢ãƒ¼ãƒ‰</span>
    </label>

    <span class="spacer"></span>

    <button id="btnLogin" class="secondary">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="btnLogout" class="secondary" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    <span class="pill" id="userLabel" style="display:none;"></span>
  </div>

  <div class="meta" id="topStats"></div>
  <div class="hint" id="studyHint" style="display:none;">
    å‹‰å¼·ãƒ¢ãƒ¼ãƒ‰ï¼šè§£èª¬ã‚’èª­ã‚“ã§ã€Œç†è§£ã—ãŸã€ã‚’æŠ¼ã™ã¾ã§æ¬¡ã¸é€²ã‚ã¾ã›ã‚“ï¼ˆå®šç€ç”¨ï¼‰
  </div>
</header>

<main>
  <div class="card">
    <h2 id="question">é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„</h2>
    <div id="choices"></div>

    <div class="result" id="resultBox">
      <div id="resultText"></div>
      <div class="meta" id="explanation"></div>

      <div class="row" style="margin-top:10px;">
        <button id="btnToggleWrong" class="secondary">ã“ã®å•é¡Œã‚’ã€Œé–“é•ã„ã€ã«ã™ã‚‹</button>

        <button id="btnUnderstood" class="secondary" style="display:none;">
          âœ… è§£èª¬ã‚’èª­ã‚“ã ï¼ˆç†è§£ã—ãŸï¼‰
        </button>

        <button id="btnNext" class="ok">æ¬¡ã¸</button>
      </div>
    </div>

    <div class="meta" id="status"></div>
  </div>
</main>

<!-- é–“é•ã„ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modalBackdrop" id="modalBg">
  <div class="modal">
    <div class="row" style="justify-content:space-between;">
      <h2>é–“é•ã„ä¸€è¦§</h2>
      <button id="btnCloseModal" class="secondary">é–‰ã˜ã‚‹</button>
    </div>

    <div class="row" style="margin:10px 0;">
      <span class="pill" id="wrongCountPill">0 ä»¶</span>
      <button id="btnExportWrong" class="secondary">IDã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>

    <div class="meta" style="margin:8px 0;">
      ãƒ»ä¸€è¦§ã®ã€Œè¡¨ç¤ºã€ã§å•é¡Œã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã¾ã™  
      ãƒ»ã€Œè§£é™¤ã€ã§é–“é•ã„ãƒªã‚¹ãƒˆã‹ã‚‰å¤–ã›ã¾ã™
    </div>

    <div id="wrongList"></div>
  </div>
</div>

<script type="module">
  import { QUESTIONS } from "./all_questions.js";
  import {
    watchAuthState,
    loginWithGoogle,
    logout,
    loadWrongs,
    saveWrongs
  } from "./firebase-auth.js";

  // ---- DOM ----
  const lectureFilter = document.getElementById("lectureFilter");
  const btnStart = document.getElementById("btnStart");
  const btnWrong = document.getElementById("btnWrong");
  const btnWrongList = document.getElementById("btnWrongList");
  const btnWrongReset = document.getElementById("btnWrongReset");

  const questionEl = document.getElementById("question");
  const choicesEl = document.getElementById("choices");
  const resultBox = document.getElementById("resultBox");
  const resultText = document.getElementById("resultText");
  const explanationEl = document.getElementById("explanation");
  const btnNext = document.getElementById("btnNext");
  const btnToggleWrong = document.getElementById("btnToggleWrong");
  const btnUnderstood = document.getElementById("btnUnderstood");
  const statusEl = document.getElementById("status");
  const topStats = document.getElementById("topStats");

  const modalBg = document.getElementById("modalBg");
  const btnCloseModal = document.getElementById("btnCloseModal");
  const wrongListEl = document.getElementById("wrongList");
  const wrongCountPill = document.getElementById("wrongCountPill");
  const btnExportWrong = document.getElementById("btnExportWrong");

  const btnLogin = document.getElementById("btnLogin");
  const btnLogout = document.getElementById("btnLogout");
  const userLabel = document.getElementById("userLabel");

  const studyModeToggle = document.getElementById("studyModeToggle");
  const studyHint = document.getElementById("studyHint");

  // ---- storage ----
  const KEY_WRONG = "bio2_wrongs";
  let wrongs = JSON.parse(localStorage.getItem(KEY_WRONG) || "[]");

  // ---- auth state ----
  let currentUser = null;
  let syncing = false;

  // ---- mode ----
  let studyMode = false;

  // ---- quiz state ----
  let pool = [];
  let index = 0;

  function renderTopStats() {
    const who = currentUser ? ` / ãƒ­ã‚°ã‚¤ãƒ³ä¸­` : ` / æœªãƒ­ã‚°ã‚¤ãƒ³ï¼ˆç«¯æœ«ä¿å­˜ï¼‰`;
    const mode = studyMode ? ` / ğŸ“˜å‹‰å¼·ãƒ¢ãƒ¼ãƒ‰` : ``;
    topStats.textContent = `å•é¡Œæ•° ${QUESTIONS.length} / é–“é•ã„ ${wrongs.length}${who}${mode}`;
  }

  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function getFilteredQuestions() {
    const lec = lectureFilter.value;
    if (lec === "all") return QUESTIONS;
    return QUESTIONS.filter(q => String(q.lecture) === String(lec));
  }

  function start(mode) {
    let filtered = getFilteredQuestions();
    if (mode === "wrong") filtered = filtered.filter(q => wrongs.includes(q.id));

    pool = shuffle(filtered);
    index = 0;
    show();
  }

  function show() {
    resultBox.style.display = "none";
    btnNext.disabled = false;
    btnUnderstood.style.display = "none";

    if (!pool.length) {
      questionEl.textContent = "å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒ•ã‚£ãƒ«ã‚¿/é–“é•ã„ãŒ0ä»¶ï¼‰";
      choicesEl.innerHTML = "";
      statusEl.textContent = "";
      return;
    }

    if (index >= pool.length) {
      questionEl.textContent = "çµ‚äº†ï¼";
      choicesEl.innerHTML = "";
      statusEl.textContent = "";
      return;
    }

    const q = pool[index];
    questionEl.textContent = `ï¼ˆç¬¬${q.lecture}è¬›ï¼‰ ${q.question}`;
    choicesEl.innerHTML = "";

    q.choices.forEach((c, i) => {
      const b = document.createElement("button");
      b.className = "choice";
      b.textContent = `${i + 1}. ${c}`;
      b.onclick = () => answer(i);
      choicesEl.appendChild(b);
    });

    statusEl.textContent = `é€²æ— ${index + 1} / ${pool.length}`;
  }

  function setToggleWrongButton(q) {
    const isWrong = wrongs.includes(q.id);
    btnToggleWrong.textContent = isWrong ? "ã“ã®å•é¡Œã‚’ã€Œé–“é•ã„ã€ã‹ã‚‰è§£é™¤" : "ã“ã®å•é¡Œã‚’ã€Œé–“é•ã„ã€ã«ã™ã‚‹";
    btnToggleWrong.className = isWrong ? "danger" : "secondary";
    btnToggleWrong.onclick = () => {
      toggleWrong(q.id);
      setToggleWrongButton(q);
    };
  }

  function toggleWrong(id) {
    if (wrongs.includes(id)) wrongs = wrongs.filter(x => x !== id);
    else wrongs.push(id);
    saveWrongsUniversal();
  }

  function answer(i) {
    const q = pool[index];
    const correct = i === q.answer;

    resultBox.style.display = "block";
    resultBox.className = "result " + (correct ? "good" : "bad");

    // å‹‰å¼·ãƒ¢ãƒ¼ãƒ‰ï¼šç‚¹æ•°æ„Ÿã‚’å¼±ã‚ã¦ã€Œç†è§£ã€ã‚’å„ªå…ˆ
    if (studyMode) {
      resultText.textContent = correct ? "âœ… æ­£è§£ï¼ˆè§£èª¬ã§ç¢ºèªã—ã¦å®šç€ï¼‰" : "âŒ ã“ã“ãŒå¼±ç‚¹ï¼ˆè§£èª¬ã§ä¿®æ­£ï¼‰";
    } else {
      resultText.textContent = correct ? "âœ… æ­£è§£ï¼" : "âŒ ä¸æ­£è§£";
    }

    explanationEl.textContent =
      `æ­£è§£ï¼š${q.answer + 1}. ${q.choices[q.answer]}\n\nè§£èª¬ï¼š${q.explanation || ""}`;

    // ä¸æ­£è§£ã¯è‡ªå‹•ã§ã€Œé–“é•ã„ã€å…¥ã‚Šï¼ˆå‹‰å¼·åŠ¹ç‡ã®ãŸã‚æ®‹ã™ï¼‰
    if (!correct && !wrongs.includes(q.id)) {
      wrongs.push(q.id);
      saveWrongsUniversal();
    }

    setToggleWrongButton(q);

    // å‹‰å¼·ãƒ¢ãƒ¼ãƒ‰ï¼šè§£èª¬ã‚’èª­ã‚“ã§ã‹ã‚‰æ¬¡ã¸
    if (studyMode) {
      btnNext.disabled = true;
      btnUnderstood.style.display = "";
      btnUnderstood.onclick = () => {
        btnNext.disabled = false;
        btnUnderstood.style.display = "none";
      };
    }
  }

  btnNext.onclick = () => {
    index++;
    show();
  };

  btnStart.onclick = () => start("random");
  btnWrong.onclick = () => start("wrong");

  btnWrongReset.onclick = () => {
    wrongs = [];
    saveWrongsUniversal();
    alert("é–“é•ã„ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
  };

  // ---- é–“é•ã„ä¸€è¦§ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ ----
  function openWrongList() {
    modalBg.style.display = "flex";
    renderWrongList();
  }
  function closeWrongList() {
    modalBg.style.display = "none";
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function renderWrongList() {
    const filteredBank = getFilteredQuestions();
    const wrongQuestions = filteredBank.filter(q => wrongs.includes(q.id));

    wrongCountPill.textContent = `${wrongQuestions.length} ä»¶`;
    wrongListEl.innerHTML = "";

    if (!wrongQuestions.length) {
      wrongListEl.innerHTML = `<div class="meta">é–“é•ã„ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆã¾ãŸã¯ãƒ•ã‚£ãƒ«ã‚¿ã§0ä»¶ï¼‰</div>`;
      return;
    }

    wrongQuestions
      .sort((a,b) => (a.lecture - b.lecture) || String(a.id).localeCompare(String(b.id)))
      .forEach(q => {
        const item = document.createElement("div");
        item.className = "listItem";

        const left = document.createElement("div");
        left.className = "left";
        left.innerHTML = `
          <div><span class="pill">ç¬¬${q.lecture}è¬›</span> <span class="pill">ID: ${escapeHtml(q.id)}</span></div>
          <div style="margin-top:6px;">${escapeHtml(q.question)}</div>
          <div class="small" style="margin-top:6px;">æ­£è§£ï¼š${q.answer + 1}. ${escapeHtml(q.choices[q.answer])}</div>
        `;

        const right = document.createElement("div");
        right.className = "row";

        const btnPreview = document.createElement("button");
        btnPreview.className = "secondary";
        btnPreview.textContent = "è¡¨ç¤º";
        btnPreview.onclick = () => {
          pool = [q];
          index = 0;
          show();

          resultBox.style.display = "block";
          resultBox.className = "result";
          resultText.textContent = "ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰";
          explanationEl.textContent =
            `æ­£è§£ï¼š${q.answer + 1}. ${q.choices[q.answer]}\n\nè§£èª¬ï¼š${q.explanation || ""}`;

          setToggleWrongButton(q);

          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã‚‚å‹‰å¼·ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡
          if (studyMode) {
            btnNext.disabled = true;
            btnUnderstood.style.display = "";
            btnUnderstood.onclick = () => {
              btnNext.disabled = false;
              btnUnderstood.style.display = "none";
            };
          } else {
            btnNext.disabled = false;
            btnUnderstood.style.display = "none";
          }

          closeWrongList();
        };

        const btnRemove = document.createElement("button");
        btnRemove.className = "danger";
        btnRemove.textContent = "è§£é™¤";
        btnRemove.onclick = () => {
          wrongs = wrongs.filter(x => x !== q.id);
          saveWrongsUniversal();
          renderWrongList();
        };

        right.appendChild(btnPreview);
        right.appendChild(btnRemove);

        item.appendChild(left);
        item.appendChild(right);
        wrongListEl.appendChild(item);
      });
  }

  btnWrongList.onclick = openWrongList;
  btnCloseModal.onclick = closeWrongList;
  modalBg.addEventListener("click", (e) => {
    if (e.target === modalBg) closeWrongList();
  });

  btnExportWrong.onclick = async () => {
    const filteredBank = getFilteredQuestions();
    const wrongQuestions = filteredBank.filter(q => wrongs.includes(q.id));
    const text = wrongQuestions.map(q => q.id).join("\n");
    try {
      await navigator.clipboard.writeText(text);
      alert("é–“é•ã„IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
    } catch {
      alert("ã‚³ãƒ”ãƒ¼å¤±æ•—â€¦ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ¨©é™ã®éƒ½åˆï¼‰\nä¸€è¦§ã‹ã‚‰æ‰‹å‹•ã§ã‚³ãƒ”ãƒšã—ã¦ã­");
    }
  };

  // ---- ä¿å­˜ï¼šæœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ç«¯æœ«ã€ãƒ­ã‚°ã‚¤ãƒ³ä¸­ãªã‚‰Firestoreã«ã‚‚ ----
  async function saveWrongsUniversal() {
    localStorage.setItem(KEY_WRONG, JSON.stringify(wrongs));

    if (currentUser && !syncing) {
      try {
        await saveWrongs(currentUser.uid, wrongs);
      } catch (e) {
        console.warn("ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜å¤±æ•—ï¼ˆç«¯æœ«ã«ã¯ä¿å­˜æ¸ˆã¿ï¼‰", e);
      }
    }

    renderTopStats();
  }

  // ---- å‹‰å¼·ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ----
  studyModeToggle.onchange = () => {
    studyMode = !!studyModeToggle.checked;
    studyHint.style.display = studyMode ? "" : "none";
    renderTopStats();

    // é€”ä¸­ã§åˆ‡æ›¿ã•ã‚ŒãŸã¨ãã®è¡¨ç¤ºå´©ã‚Œã‚’é˜²ã
    if (resultBox.style.display === "block") {
      btnNext.disabled = studyMode;
      btnUnderstood.style.display = studyMode ? "" : "none";
      if (studyMode) {
        btnUnderstood.onclick = () => {
          btnNext.disabled = false;
          btnUnderstood.style.display = "none";
        };
      }
    }
  };

  // ---- ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ----
  btnLogin.onclick = async () => {
    try { await loginWithGoogle(); }
    catch (e) { alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + (e?.message || e)); }
  };

  btnLogout.onclick = async () => {
    try { await logout(); }
    catch (e) { alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—: " + (e?.message || e)); }
  };

  watchAuthState(async (user) => {
    currentUser = user;

    if (!user) {
      btnLogin.style.display = "";
      btnLogout.style.display = "none";
      userLabel.style.display = "none";
      renderTopStats();
      return;
    }

    btnLogin.style.display = "none";
    btnLogout.style.display = "";
    userLabel.style.display = "";
    userLabel.textContent = user.displayName || user.email || "ãƒ­ã‚°ã‚¤ãƒ³ä¸­";

    try {
      syncing = true;
      const cloudWrongs = await loadWrongs(user.uid);
      wrongs = Array.isArray(cloudWrongs) ? cloudWrongs : [];
      localStorage.setItem(KEY_WRONG, JSON.stringify(wrongs));
      renderTopStats();
      if (modalBg.style.display === "flex") renderWrongList();
    } finally {
      syncing = false;
    }
  });

  // init
  renderTopStats();
  console.log("QUESTIONS loaded:", QUESTIONS?.length);
</script>
</body>
</html>
